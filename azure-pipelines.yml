trigger:
  branches:
    include:
      - master   # your branch

pool:
  vmImage: 'ubuntu-latest'   # Microsoft-hosted agent

variables:
  node_version: '22.x'                 # Node version
  build_folder: 'build'                # Build output folder
  azure_service_connection: 'Vinay-Azure-Connection'  # Azure service connection name
  app_service_name: 'credManager'      # Azure App Service name
  startup_command: 'npm start'         # Startup command for App Service

steps:
# 1️⃣ Checkout code
- task: Checkout@1

# 2️⃣ Install Node
- task: NodeTool@0
  inputs:
    versionSpec: '$(node_version)'
  displayName: 'Use Node $(node_version)'

# 3️⃣ Install dependencies
- script: |
    npm install
  displayName: 'Install dependencies'

# 4️⃣ Build Vite + React Router SSR
- script: |
    npm run build
  displayName: 'Build SSR app'

# 5️⃣ Zip build folder
- task: ArchiveFiles@2
  inputs:
    rootFolderOrFile: '$(Build.SourcesDirectory)/$(build_folder)'
    includeRootFolder: false
    archiveType: 'zip'
    archiveFile: '$(Build.ArtifactStagingDirectory)/app.zip'
    replaceExistingArchive: true
  displayName: 'Archive build folder'

# 6️⃣ Publish artifact (optional)
- publish: $(Build.ArtifactStagingDirectory)/app.zip
  artifact: drop

# 7️⃣ Deploy to Azure App Service
- task: AzureWebApp@1
  inputs:
    azureSubscription: '$(azure_service_connection)'
    appType: 'webApp'       
    appName: '$(app_service_name)'
    package: '$(Build.ArtifactStagingDirectory)/app.zip'
    startupCommand: '$(startup_command)'
